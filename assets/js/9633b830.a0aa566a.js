"use strict";(self.webpackChunkharvesterhci_io=self.webpackChunkharvesterhci_io||[]).push([[7559],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return h}});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=i.createContext({}),c=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=c(e.components);return i.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},p=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=r,d=p["".concat(l,".").concat(h)]||p[h]||u[h]||a;return n?i.createElement(d,o(o({ref:t},m),{},{components:n})):i.createElement(d,o({ref:t},m))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<a;c++)o[c]=n[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}p.displayName="MDXCreateElement"},1833:function(e,t,n){n.r(t),n.d(t,{assets:function(){return m},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return u}});var i=n(7462),r=n(3366),a=(n(7294),n(3905)),o=["components"],s={title:"Mitigating fstrim Risk",description:"The potential risk with fstrim and how to avoid it",slug:"the_potential_risk_with_fstrim",authors:[{name:"Vicente Cheng",title:"Senior Software Engineer",url:"https://github.com/Vicente-Cheng",image_url:"https://github.com/Vicente-Cheng.png"}],tags:["harvester","rancher integration","longhorn","fstrim"],hide_table_of_contents:!1},l=void 0,c={permalink:"/kb/the_potential_risk_with_fstrim",editUrl:"https://github.com/harvester/harvesterhci.io/edit/main/kb/kb/2024-01-30/the_potential_risk_with_fstrim.md",source:"@site/kb/2024-01-30/the_potential_risk_with_fstrim.md",title:"Mitigating fstrim Risk",description:"The potential risk with fstrim and how to avoid it",date:"2024-01-30T00:00:00.000Z",formattedDate:"January 30, 2024",tags:[{label:"harvester",permalink:"/kb/tags/harvester"},{label:"rancher integration",permalink:"/kb/tags/rancher-integration"},{label:"longhorn",permalink:"/kb/tags/longhorn"},{label:"fstrim",permalink:"/kb/tags/fstrim"}],readingTime:1.79,truncated:!1,authors:[{name:"Vicente Cheng",title:"Senior Software Engineer",url:"https://github.com/Vicente-Cheng",image_url:"https://github.com/Vicente-Cheng.png",imageURL:"https://github.com/Vicente-Cheng.png"}],frontMatter:{title:"Mitigating fstrim Risk",description:"The potential risk with fstrim and how to avoid it",slug:"the_potential_risk_with_fstrim",authors:[{name:"Vicente Cheng",title:"Senior Software Engineer",url:"https://github.com/Vicente-Cheng",image_url:"https://github.com/Vicente-Cheng.png",imageURL:"https://github.com/Vicente-Cheng.png"}],tags:["harvester","rancher integration","longhorn","fstrim"],hide_table_of_contents:!1},prevItem:{title:"Configuring Harvester to Boot from an iSCSI Root Disk in Special Circumstances",permalink:"/kb/install_iscsi_firmware_install_boot"},nextItem:{title:"Calculation of Resource Metrics in Harvester",permalink:"/kb/calculation_of_resource_metrics_in_harvester"}},m={authorsImageUrls:[void 0]},u=[{value:"Risks Associated with fstrim Usage",id:"risks-associated-with-fstrim-usage",level:2},{value:"Risk Mitigation",id:"risk-mitigation",level:2}],p={toc:u};function h(e){var t=e.components,n=(0,r.Z)(e,o);return(0,a.kt)("wrapper",(0,i.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"This issue is already resolved by Longhorn v1.5.4, v1.6.1, v1.7.0 and later versions."))),(0,a.kt)("p",null,"Using fstrim is a common way to release unused space in a filesystem. However, this utility is known to cause IO errors when used with Longhorn volumes that are rebuilding. For more information about the errors, see the following issues:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Harvester: ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/4739"},"Issue 4793")),(0,a.kt)("li",{parentName:"ul"},"Longhorn: ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/longhorn/longhorn/issues/7103"},"Issue 7103"))),(0,a.kt)("h2",{id:"risks-associated-with-fstrim-usage"},"Risks Associated with fstrim Usage"),(0,a.kt)("p",null,"A consequence of the IO errors caused by fstrim is that VMs using affected Longhorn volumes become stuck. Imagine the VM is running critical applications, then becomes unavailable. This is significant because Harvester typically uses Longhorn volumes as VM disks. The IO errors will cause VMs to flap between running and paused states until volume rebuilding is completed."),(0,a.kt)("p",null,"Although the described system behavior does not affect data integrity, it might induce panic in some users. Consider the guest Kubernetes cluster scenario. In a stuck VM, the etcd service is unavailable. The effects of this failure cascade from the Kubernetes cluster becoming unavailable to services running on the cluster becoming unavailable."),(0,a.kt)("h2",{id:"risk-mitigation"},"Risk Mitigation"),(0,a.kt)("p",null,"One way to mitigate the described risks is to disable fstrim in VMs. fstrim is enabled by default in many modern Linux distributions.\nYou can determine if fstrim is enabled in VMs that use affected Longhorn volumes by checking the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"/etc/fstab"),": Some root filesystems mount with the ",(0,a.kt)("em",{parentName:"p"},"discard")," option."),(0,a.kt)("p",{parentName:"li"},"Example:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"/dev/mapper/rootvg-rootlv /                       xfs     defaults,discard        0 0\n")),(0,a.kt)("p",{parentName:"li"},"You can disable fstrim on the root filesystem by removing the ",(0,a.kt)("em",{parentName:"p"},"discard")," option."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"/dev/mapper/rootvg-rootlv /                       xfs     defaults        0 0   <-- remove the discard option\n")),(0,a.kt)("p",{parentName:"li"},"After removing the ",(0,a.kt)("em",{parentName:"p"},"discard")," option, you can remount the root filesystem using the command ",(0,a.kt)("inlineCode",{parentName:"p"},"mount -o remount /")," or by rebooting the VM.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"fstrim.timer"),": When this service is enabled, fstrim executes weekly by default. You can either disable the service or edit the service file to prevent simultaneous fstrim execution on VMs."),(0,a.kt)("p",{parentName:"li"},"You can disable the service using the following command:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"systemctl disable fstrim.timer\n")),(0,a.kt)("p",{parentName:"li"},"To prevent simultaneous fstrim execution, use the following values in the service file (located at ",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/lib/systemd/system/fstrim.timer"),"):"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"[Timer]\nOnCalendar=weekly\nAccuracySec=1h\nPersistent=true\nRandomizedDelaySec=6000\n")))))}h.isMDXComponent=!0}}]);