<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-56382716-11","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="alternate" type="application/rss+xml" href="/kb/rss.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kb/atom.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world Atom Feed"><title data-rh="true">Harvester HCI knowledge base | The open-source hyperconverged infrastructure solution for a cloud-native world</title><meta data-rh="true" property="og:title" content="Harvester HCI knowledge base | The open-source hyperconverged infrastructure solution for a cloud-native world"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" property="og:url" content="https://harvesterhci.io/kb"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://harvesterhci.io/kb"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb" hreflang="en"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2a831778.css">
<link rel="preload" href="/assets/js/runtime~main.f5155a29.js" as="script">
<link rel="preload" href="/assets/js/main.9c23e8a1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.harvesterhci.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__docs"><span>Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.suse.com/c/?s=harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__blog"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a aria-current="page" class="navbar__item navbar__link navbar__kb navbar__link--active" href="/kb">Knowledge Base</a><a href="https://github.com/harvester/harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">More from SUSE</a><ul class="dropdown__menu"><li><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rancher"><span>Rancher<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://elemental.docs.rancher.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__elemental"><span>Elemental<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://fleet.rancher.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__fleet"><span>Fleet<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://opensource.suse.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__suse"><span>More Projects...<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">All Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/calculation_of_resource_metrics_in_harvester">Calculation of Resource Metrics in Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/best_practices_for_optimizing_longhorn_disk_performance">Best Practices for Optimizing Longhorn Disk Performance</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm_live_migration_policy_and_configuration">VM Live Migration Policy and Configuration</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/use_rook_ceph_external_storage">Use Rook Ceph External Storage with Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/install_netapp_trident_csi">Using NetApp Storage on Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/package_your_own_toolbox_image">Package your own Toolbox Image</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/nic-naming-scheme">NIC Naming Scheme</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/multiple-nics-vm-connectivity">Multiple NICs VM Connectivity</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm-scheduling">VM Scheduling</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/calculation_of_resource_metrics_in_harvester">Calculation of Resource Metrics in Harvester</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-01-23T00:00:00.000Z" itemprop="datePublished">January 23, 2024</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/w13915984028.png" alt="Jian Wang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jian Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Harvester calculates the resource metrics using data that is dynamically collected from the system. Host-level resource metrics are calculated and then aggregated to obtain the cluster-level metrics.</p><p>You can view resource-related metrics on the Harvester UI.</p><ul><li><p><strong>Hosts</strong> screen: Displays host-level metrics</p><p><img loading="lazy" alt="host level resources metrics" src="/assets/images/host-resource-usage-3f7d2c16335caae1ef42aa94f62a0dcb.png" width="3198" height="606"></p></li><li><p><strong>Dashboard</strong> screen: Displays cluster-level metrics</p><p><img loading="lazy" alt="cluster level resources metrics" src="/assets/images/cluster-resource-usage-6165985252a3fce5f61a11807124c423.png" width="3168" height="488"></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="cpu-and-memory">CPU and Memory<a class="hash-link" href="#cpu-and-memory" title="Direct link to heading">â</a></h2><p>The following sections describe the data sources and calculation methods for CPU and memory resources.</p><ul><li>Resource capacity: Baseline data</li><li>Resource usage: Data source for the <strong>Used</strong> field on the <strong>Hosts</strong> screen</li><li>Resource reservation: Data source for the <strong>Reserved</strong> field on the <strong>Hosts</strong> screen</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="resource-capacity">Resource Capacity<a class="hash-link" href="#resource-capacity" title="Direct link to heading">â</a></h3><p>In Kubernetes, a <code>Node</code> object is created for each host.</p><p>The <code>.status.allocatable.cpu</code> and <code>.status.allocatable.memory</code> represent the available CPU and Memory resources of a host.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl get nodes -A -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-limits: &#x27;{&quot;cpu&quot;:&quot;12715m&quot;,&quot;devices.kubevirt.io/kvm&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/tun&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/vhost-net&quot;:&quot;1&quot;,&quot;memory&quot;:&quot;17104951040&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-requests: &#x27;{&quot;cpu&quot;:&quot;5657m&quot;,&quot;devices.kubevirt.io/kvm&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/tun&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/vhost-net&quot;:&quot;1&quot;,&quot;ephemeral-storage&quot;:&quot;50M&quot;,&quot;memory&quot;:&quot;9155862208&quot;,&quot;pods&quot;:&quot;78&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node.alpha.kubernetes.io/ttl: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resourceVersion: &quot;2170215&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uid: b6f5850a-2fbc-4aef-8fbe-121dfb671b67</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    podCIDR: 10.52.0.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    podCIDRs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 10.52.0.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    providerID: rke2://harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addresses:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - address: 192.168.122.141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: InternalIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - address: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: Hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allocatable:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cpu: &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/kvm: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/tun: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/vhost-net: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ephemeral-storage: &quot;149527126718&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-1Gi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-2Mi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memory: 20464216Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods: &quot;200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cpu: &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/kvm: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/tun: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/vhost-net: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ephemeral-storage: 153707984Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-1Gi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-2Mi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memory: 20464216Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods: &quot;200&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="resource-usage">Resource Usage<a class="hash-link" href="#resource-usage" title="Direct link to heading">â</a></h3><p>CPU and memory usage data is continuously collected and stored in the <code>NodeMetrics</code> object. Harvester reads the data from <code>usage.cpu</code> and <code>usage.memory</code>.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl get NodeMetrics -A -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: metrics.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: NodeMetrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timestamp: &quot;2024-01-23T12:04:44Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpu: 891736742n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memory: 9845008Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  window: 10.149s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="resource-reservation">Resource Reservation<a class="hash-link" href="#resource-reservation" title="Direct link to heading">â</a></h3><p>Harvester dynamically calculates the resource limits and requests of all pods running on a host, and updates the information to the annotations of the <code>NodeMetrics</code> object.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-limits: &#x27;{&quot;cpu&quot;:&quot;12715m&quot;,...,&quot;memory&quot;:&quot;17104951040&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-requests: &#x27;{&quot;cpu&quot;:&quot;5657m&quot;,...,&quot;memory&quot;:&quot;9155862208&quot;}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For more information, see <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits" target="_blank" rel="noopener noreferrer">Requests and Limits</a> in the Kubernetes documentation.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="storage">Storage<a class="hash-link" href="#storage" title="Direct link to heading">â</a></h2><p>Longhorn is the default Container Storage Interface (CSI) driver of Harvester, providing storage management features such as distributed block storage and tiering.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="reserved-storage-in-longhorn">Reserved Storage in Longhorn<a class="hash-link" href="#reserved-storage-in-longhorn" title="Direct link to heading">â</a></h3><p>Longhorn allows you to specify the percentage of disk space that is not allocated to the default disk on each new Longhorn node. The default value is &quot;30&quot;. For more information, see <a href="https://longhorn.io/docs/1.5.3/references/settings/#storage-reserved-percentage-for-default-disk" target="_blank" rel="noopener noreferrer">Storage Reserved Percentage For Default Disk</a> in the Longhorn documentation.</p><p>Depending on the disk size, you can modify the default value using the <a href="https://docs.harvesterhci.io/v1.2/troubleshooting/harvester/#access-embedded-rancher-and-longhorn-dashboards" target="_blank" rel="noopener noreferrer">embedded Longhorn UI</a>.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Before changing the settings, read the Longhorn documentation carefully.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="data-sources-and-calculation">Data Sources and Calculation<a class="hash-link" href="#data-sources-and-calculation" title="Direct link to heading">â</a></h3><p>Harvester uses the following data to calculate metrics for storage resources.</p><ul><li><p>Sum of the <code>storageMaximum</code> values of all disks (<code>status.diskStatus.disk-name</code>): Total storage capacity</p></li><li><p>Total storage capacity - Sum of the <code>storageAvailable</code> values of all disks (<code>status.diskStatus.disk-name</code>): Data source for the <strong>Used</strong> field on the <strong>Hosts</strong> screen</p></li><li><p>Sum of the <code>storageReserved</code> values of all disks (<code>spec.disks</code>): Data source for the <strong>Reserved</strong> field on the <strong>Hosts</strong> screen</p></li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl get nodes.longhorn.io -n longhorn-system -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: longhorn.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace: longhorn-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowScheduling: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disks:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      default-disk-ef11a18c36b01132:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allowScheduling: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskType: filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        evictionRequested: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /var/lib/harvester/defaultdisk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageReserved: 24220101427</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tags: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    diskStatus:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      default-disk-ef11a18c36b01132:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskType: filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskUUID: d2788933-8817-44c6-b688-dee414cc1f73</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduledReplica:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-95561210-c39c-4c2e-ac9a-4a9bd72b3100-r-20affeca: 2147483648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-9e83b2dc-6a4b-4499-ba70-70dc25b2d9aa-r-4ad05c86: 32212254720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-bc25be1e-ca4e-4818-a16d-48353a0f2f96-r-c7b88c60: 3221225472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-d9d3e54d-8d67-4740-861e-6373f670f1e4-r-f4c7c338: 2147483648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-e954b5fe-bbd7-4d44-9866-6ff6684d5708-r-ba6b87b6: 5368709120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageAvailable: 77699481600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageMaximum:   80733671424</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageScheduled: 45097156608</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshotCheckStatus: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zone: &quot;&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/resource-metrics">resource metrics</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/reserved-resource">reserved resource</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/calculation">calculation</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/best_practices_for_optimizing_longhorn_disk_performance">Best Practices for Optimizing Longhorn Disk Performance</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-12-27T00:00:00.000Z" itemprop="datePublished">December 27, 2023</time> Â· <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/innobead" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/innobead.png" alt="David Ko"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/innobead" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">David Ko</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineering Manager</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/jillian-maroket/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/jillian-maroket.png" alt="Jillian Maroket"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jillian-maroket/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jillian Maroket</span></a></div><small class="avatar__subtitle" itemprop="description">Technical Writer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The Longhorn documentation provides <a href="https://longhorn.io/docs/1.5.3/best-practices/" target="_blank" rel="noopener noreferrer">best practice recommendations</a> for deploying Longhorn in production environments. Before configuring workloads, ensure that you have set up the following basic requirements for optimal disk performance.</p><ul><li>SATA/NVMe SSDs or disk drives with similar performance</li><li>10 Gbps network bandwidth between nodes</li><li>Dedicated Priority Classes for system-managed and user-deployed Longhorn components</li></ul><p>The following sections outline other recommendations for achieving optimal disk performance.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="io-performance">IO Performance<a class="hash-link" href="#io-performance" title="Direct link to heading">â</a></h2><ul><li><p><strong>Storage network</strong>: Use a <a href="https://docs.harvesterhci.io/v1.2/advanced/storagenetwork" target="_blank" rel="noopener noreferrer">dedicated storage network</a> to improve IO performance and stability.  </p></li><li><p><strong>Longhorn disk</strong>: Use a <a href="https://docs.harvesterhci.io/v1.2/host/#multi-disk-management" target="_blank" rel="noopener noreferrer">dedicated disk</a> for Longhorn storage instead of using the root disk.  </p></li><li><p><strong>Replica count</strong>: Set the <a href="https://docs.harvesterhci.io/v1.2/advanced/storageclass#parameters-tab" target="_blank" rel="noopener noreferrer">default replica count</a> to &quot;2&quot; to achieve data availability with better disk space usage or less impact to system performance. This practice is especially beneficial to data-intensive applications.  </p></li><li><p><strong>Storage tag</strong>: Use storage tags to define storage tiering for data-intensive applications. For example, only high-performance disks can be used for storing performance-sensitive data. You can either <a href="https://docs.harvesterhci.io/v1.2/host/#storage-tags" target="_blank" rel="noopener noreferrer">add disks with tags</a> or <a href="https://docs.harvesterhci.io/v1.2/advanced/storageclass#disk-selector-optional" target="_blank" rel="noopener noreferrer">create StorageClasses with tags</a>.  </p></li><li><p><strong>Data locality</strong>: Use <code>best-effort</code> as the default <a href="https://longhorn.io/docs/1.5.3/high-availability/data-locality/" target="_blank" rel="noopener noreferrer">data locality</a> of Longhorn Storage Classes.  </p><p>For applications that support data replication (for example, a distributed database), you can use the <code>strict-local</code> option to ensure that only one replica is created for each volume. This practice prevents the extra disk space usage and IO performance overhead associated with volume replication.  </p><p>For data-intensive applications, you can use pod scheduling functions such as node selector or taint toleration. These functions allow you to schedule the workload to a specific storage-tagged node together with one replica.  </p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="space-efficiency">Space Efficiency<a class="hash-link" href="#space-efficiency" title="Direct link to heading">â</a></h2><ul><li><p><strong>Recurring snapshots</strong>: Periodically clean up system-generated snapshots and retain only the number of snapshots that makes sense for your implementation. </p><p>For applications with replication capability, periodically <a href="https://longhorn.io/docs/1.5.3/concepts/#243-deleting-snapshots" target="_blank" rel="noopener noreferrer">delete all types of snapshots</a>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="disaster-recovery">Disaster Recovery<a class="hash-link" href="#disaster-recovery" title="Direct link to heading">â</a></h2><ul><li><p><strong>Recurring backups</strong>: Create <a href="https://longhorn.io/docs/1.5.3/volumes-and-nodes/trim-filesystem/" target="_blank" rel="noopener noreferrer">recurring backup jobs</a> for mission-critical application volumes.</p></li><li><p><strong>System backup</strong>: Run periodic system backups.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/best-practices">best practices</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/disk-performance">disk performance</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/vm_live_migration_policy_and_configuration">VM Live Migration Policy and Configuration</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-09-01T00:00:00.000Z" itemprop="datePublished">September 1, 2023</time> Â· <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/w13915984028.png" alt="Jian Wang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jian Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In Harvester, the <strong>VM Live Migration</strong> is well supported by the UI. Please refer to <a href="https://docs.harvesterhci.io/v1.1/vm/live-migration" target="_blank" rel="noopener noreferrer">Harvester VM Live Migration</a> for more details.</p><p>The VM Live Migration process is finished smoothly in most cases. However, sometimes the migration may get stuck and not end as expected.</p><p>This article dives into the VM Live Migration process in more detail. There are three main parts:</p><ul><li>General Process of VM Live Migration</li><li>VM Live Migration Strategies</li><li>VM Live Migration Configurations</li></ul><p>Related issues:</p><ul><li><a href="https://github.com/harvester/harvester/issues/4352" target="_blank" rel="noopener noreferrer">Migration should show the proper status and progress in the UI</a></li><li><a href="https://github.com/harvester/harvester/issues/4376" target="_blank" rel="noopener noreferrer">VM Migration policy and status</a></li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>A big part of the following contents are copied from <code>kubevirt</code> document <a href="https://kubevirt.io/user-guide/operations/live_migration/" target="_blank" rel="noopener noreferrer">https://kubevirt.io/user-guide/operations/live_migration/</a>, some contents/formats are adjusted to fit in this document.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="general-process-of-vm-live-migration">General Process of VM Live Migration<a class="hash-link" href="#general-process-of-vm-live-migration" title="Direct link to heading">â</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="starting-a-migration-from-harvester-ui">Starting a Migration from Harvester UI<a class="hash-link" href="#starting-a-migration-from-harvester-ui" title="Direct link to heading">â</a></h3><ol><li>Go to the <strong>Virtual Machines</strong> page.</li><li>Find the virtual machine that you want to migrate and select <strong>â®</strong> &gt; <strong>Migrate</strong>.</li><li>Choose the node to which you want to migrate the virtual machine and select <strong>Apply</strong>.</li></ol><p>After successfully selecting <strong>Apply</strong>, a CRD <code>VirtualMachineInstanceMigration</code> object is created, and the related <code>controller/operator</code> will start the process.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-crd-object">Migration CRD Object<a class="hash-link" href="#migration-crd-object" title="Direct link to heading">â</a></h3><p>You can also create the CRD <code>VirtualMachineInstanceMigration</code> object manually via <code>kubectl</code> or other tools.</p><p>The example below starts a migration process for a virtual machine instance (VMI) <code>new-vm</code>.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubevirt.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: VirtualMachineInstanceMigration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: migration-job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vmiName: new-vm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Under the hood, the open source projects <code>Kubevirt, Libvirt, QEMU, ... </code> perform most of the <code>VM Live Migration</code>. <a href="#references">References.</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-status-reporting">Migration Status Reporting<a class="hash-link" href="#migration-status-reporting" title="Direct link to heading">â</a></h3><p>When starting a virtual machine instance (VMI), it has also been calculated whether the machine is live migratable. The result is being stored in the VMI <code>VMI.status.conditions</code>. The calculation can be based on multiple parameters of the VMI, however, at the moment, the calculation is largely based on the Access Mode of the VMI volumes. Live migration is only permitted when the volume access mode is set to ReadWriteMany. Requests to migrate a non-LiveMigratable VMI will be rejected.</p><p>The reported Migration Method is also being calculated during VMI start. <code>BlockMigration</code> indicates that some of the VMI disks require copying from the source to the destination. <code>LiveMigration</code> means that only the instance memory will be copied.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conditions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status: True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: LiveMigratable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Migration Method: BlockMigration</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-status">Migration Status<a class="hash-link" href="#migration-status" title="Direct link to heading">â</a></h3><p>The migration progress status is reported in <code>VMI.status</code>. Most importantly, it indicates whether the migration has been completed or failed.</p><p>Below is an example of a successful migration.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Migration State:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Completed:        true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    End Timestamp:    2019-03-29T03:37:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Migration Config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Completion Timeout Per GiB:  800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Progress Timeout:             150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Migration UID:                  c64d4898-51d3-11e9-b370-525500d15501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source Node:                    node02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Start Timestamp:                2019-03-29T04:02:47Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Direct Migration Node Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      35001:                      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      41068:                      49152</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      38284:                      49153</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Node:                  node01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Node Address:          10.128.0.46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Node Domain Detected:  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Pod:                   virt-launcher-testvmimcbjgw6zrzcmp8wpddvztvzm7x2k6cjbdgktwv8tkq</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategies">VM Live Migration Strategies<a class="hash-link" href="#vm-live-migration-strategies" title="Direct link to heading">â</a></h2><p>VM Live Migration is a process during which a running Virtual Machine Instance moves to another compute node while the guest workload continues to run and remain accessible.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="understanding-different-vm-live-migration-strategies">Understanding Different VM Live Migration Strategies<a class="hash-link" href="#understanding-different-vm-live-migration-strategies" title="Direct link to heading">â</a></h3><p>VM Live Migration is a complex process. During a migration, the source VM needs to transfer its whole state (mainly RAM) to the target VM. If there are enough resources available, such as network bandwidth and CPU power, migrations should converge nicely. If this is not the scenario, however, the migration might get stuck without an ability to progress.</p><p>The main factor that affects migrations from the guest perspective is its dirty rate, which is the rate by which the VM dirties memory. Guests with high dirty rate lead to a race during migration. On the one hand, memory would be transferred continuously to the target, and on the other, the same memory would get dirty by the guest. On such scenarios, one could consider to use more advanced migration strategies. Refer to <a href="https://kubevirt.io/user-guide/operations/live_migration/#understanding-different-migration-strategies" target="_blank" rel="noopener noreferrer">Understanding different migration strategies</a> for more details.</p><p>There are 3 <code>VM Live Migration</code> strategies/policies:</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategy-pre-copy">VM Live Migration Strategy: Pre-copy<a class="hash-link" href="#vm-live-migration-strategy-pre-copy" title="Direct link to heading">â</a></h4><p>Pre-copy is the default strategy. It should be used for most cases.</p><p>The way it works is as following:</p><ol><li>The target VM is created, but the guest keeps running on the source VM.</li><li>The source starts sending chunks of VM state (mostly memory) to the target. This continues until all of the state has been transferred to the target.</li><li>The guest starts executing on the target VM. 4. The source VM is being removed.</li></ol><p>Pre-copy is the safest and fastest strategy for most cases. Furthermore, it can be easily cancelled, can utilize multithreading, and more. If there is no real reason to use another strategy, this is definitely the strategy to go with.</p><p>However, on some cases migrations might not converge easily, that is, by the time the chunk of source VM state would be received by the target VM, it would already be mutated by the source VM (which is the VM the guest executes on). There are many reasons for migrations to fail converging, such as a high dirty-rate or low resources like network bandwidth and CPU. On such scenarios, see the following alternative strategies below.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategy-post-copy">VM Live Migration Strategy: Post-copy<a class="hash-link" href="#vm-live-migration-strategy-post-copy" title="Direct link to heading">â</a></h4><p>The way post-copy migrations work is as following:</p><ol><li>The target VM is created.</li><li>The guest is being run on the target VM.</li><li>The source starts sending chunks of VM state (mostly memory) to the target.</li><li>When the guest, running on the target VM, would access memory: 1. If the memory exists on the target VM, the guest can access it. 2. Otherwise, the target VM asks for a chunk of memory from the source VM.</li><li>Once all of the memory state is updated at the target VM, the source VM is being removed.</li></ol><p>The main idea here is that the guest starts to run immediately on the target VM. This approach has advantages and disadvantages:</p><p><strong>Advantages:</strong></p><ul><li>The same memory chink is never being transferred twice. This is possible due to the fact that with post-copy it doesn&#x27;t matter that a page had been dirtied since the guest is already running on the target VM.</li><li>This means that a high dirty-rate has much less effect.</li><li>Consumes less network bandwidth.</li></ul><p><strong>Disadvantages:</strong></p><ul><li>When using post-copy, the VM state has no one source of truth. When the guest (running on the target VM) writes to memory, this memory is one part of the guest&#x27;s state, but some other parts of it may still be updated only at the source VM. This situation is generally dangerous, since, for example, if either the target or guest VMs crash the state cannot be recovered.</li><li>Slow warmup: when the guest starts executing, no memory is present at the target VM. Therefore, the guest would have to wait for a lot of memory in a short period of time.</li><li>Slower than pre-copy on most cases.</li><li>Harder to cancel a migration.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategy-auto-converge">VM Live Migration Strategy: Auto-converge<a class="hash-link" href="#vm-live-migration-strategy-auto-converge" title="Direct link to heading">â</a></h4><p>Auto-converge is a technique to help pre-copy migrations converge faster without changing the core algorithm of how the migration works.</p><p>Since a high dirty-rate is usually the most significant factor for migrations to not converge, auto-converge simply throttles the guest&#x27;s CPU. If the migration would converge fast enough, the guest&#x27;s CPU would not be throttled or throttled negligibly. But, if the migration would not converge fast enough, the CPU would be throttled more and more as time goes.</p><p>This technique dramatically increases the probability of the migration converging eventually.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="observe-the-vm-live-migration-progress-and-result">Observe the VM Live Migration Progress and Result<a class="hash-link" href="#observe-the-vm-live-migration-progress-and-result" title="Direct link to heading">â</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="migration-timeouts">Migration Timeouts<a class="hash-link" href="#migration-timeouts" title="Direct link to heading">â</a></h4><p>Depending on the type, the live migration process will copy virtual machine memory pages and disk blocks to the destination. During this process non-locked pages and blocks are being copied and become free for the instance to use again. To achieve a successful migration, it is assumed that the instance will write to the free pages and blocks (pollute the pages) at a lower rate than these are being copied.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="completion-time">Completion Time<a class="hash-link" href="#completion-time" title="Direct link to heading">â</a></h4><p>In some cases the virtual machine can write to different memory pages / disk blocks at a higher rate than these can be copied, which will prevent the migration process from completing in a reasonable amount of time. In this case, live migration will be aborted if it is running for a long period of time. The timeout is calculated base on the size of the VMI, it&#x27;s memory and the ephemeral disks that are needed to be copied. The configurable parameter completionTimeoutPerGiB, which defaults to 800s is the time for GiB of data to wait for the migration to be completed before aborting it. A VMI with 8Gib of memory will time out after 6400 seconds.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="progress-timeout">Progress Timeout<a class="hash-link" href="#progress-timeout" title="Direct link to heading">â</a></h4><p>A VM Live Migration will also be aborted when it notices that copying memory doesn&#x27;t make any progress. The time to wait for live migration to make progress in transferring data is configurable by the <code>progressTimeout</code> parameter, which defaults to 150 seconds.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-configurations">VM Live Migration Configurations<a class="hash-link" href="#vm-live-migration-configurations" title="Direct link to heading">â</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="changing-cluster-wide-migration-limits">Changing Cluster Wide Migration Limits<a class="hash-link" href="#changing-cluster-wide-migration-limits" title="Direct link to heading">â</a></h3><p>KubeVirt puts some limits in place so that migrations don&#x27;t overwhelm the cluster. By default, it is to only run 5 migrations in parallel with an additional limit of a maximum of 2 outbound migrations per node. Finally, every migration is limited to a bandwidth of 64MiB/s.</p><p>You can change these values in the <code>kubevirt</code> CR:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: kubevirt.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: Kubevirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: kubevirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      namespace: kubevirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        migrations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          parallelMigrationsPerCluster: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          parallelOutboundMigrationsPerNode: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          bandwidthPerMigration: 64Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          completionTimeoutPerGiB: 800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          progressTimeout: 150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          disableTLS: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          nodeDrainTaintKey: &quot;kubevirt.io/drain&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          allowAutoConverge: false ---------------------&gt; related to: Auto-converge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          allowPostCopy: false -------------------------&gt; related to: Post-copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          unsafeMigrationOverride: false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Remember that most of these configurations can be overridden and fine-tuned to a specified group of VMs. For more information, please refer to the Migration Policies section below.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-policies">Migration Policies<a class="hash-link" href="#migration-policies" title="Direct link to heading">â</a></h3><p><a href="https://kubevirt.io/user-guide/operations/migration_policies/" target="_blank" rel="noopener noreferrer">Migration policies</a> provides a new way of applying migration configurations to Virtual Machines. The policies can refine Kubevirt CR&#x27;s <code>MigrationConfiguration</code> that sets the cluster-wide migration configurations. This way, the cluster-wide settings default how the migration policy can be refined (i.e., changed, removed, or added).</p><p>Remember that migration policies are in version <code>v1alpha1</code>. This means that this API is not fully stable yet and that APIs may change in the future.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="migration-configurations">Migration Configurations<a class="hash-link" href="#migration-configurations" title="Direct link to heading">â</a></h4><p>Currently, the <code>MigrationPolicy</code> spec only includes the following configurations from Kubevirt CR&#x27;s <code>MigrationConfiguration</code>. (In the future, more configurations that aren&#x27;t part of Kubevirt CR will be added):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: migrations.kubevirt.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: MigrationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowAutoConverge: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bandwidthPerMigration: 217Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    completionTimeoutPerGiB: 23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowPostCopy: false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>All the above fields are optional. When omitted, the configuration will be applied as defined in KubevirtCR&#x27;s <code>MigrationConfiguration</code>. This way, KubevirtCR will serve as a configurable set of defaults for both VMs that are not bound to any <code>MigrationPolicy</code> and VMs that are bound to a <code>MigrationPolicy</code> that does not define all fields of the configurations.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="matching-policies-to-vms">Matching Policies to VMs<a class="hash-link" href="#matching-policies-to-vms" title="Direct link to heading">â</a></h5><p>Next in the spec are the selectors defining the group of VMs to apply the policy. The options to do so are the following.</p><p>This policy applies to the VMs in namespaces that have all the required labels:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: migrations.kubevirt.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: MigrationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hpc-workloads: true       # Matches a key and a value</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The policy below applies to the VMs that have all the required labels:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: migrations.kubevirt.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: MigrationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtualMachineInstanceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      workload-type: db       # Matches a key and a value</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">â</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="documents">Documents<a class="hash-link" href="#documents" title="Direct link to heading">â</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="libvirt-guest-migration">Libvirt Guest Migration<a class="hash-link" href="#libvirt-guest-migration" title="Direct link to heading">â</a></h3><p><code>Libvirt</code> has a chapter to describe the pricipal of <code>VM/Guest Live Migration</code>.</p><p><a href="https://libvirt.org/migration.html" target="_blank" rel="noopener noreferrer">https://libvirt.org/migration.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="kubevirt-live-migration">Kubevirt Live Migration<a class="hash-link" href="#kubevirt-live-migration" title="Direct link to heading">â</a></h3><p><a href="https://kubevirt.io/user-guide/operations/live_migration/" target="_blank" rel="noopener noreferrer">https://kubevirt.io/user-guide/operations/live_migration/</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="source-code">Source Code<a class="hash-link" href="#source-code" title="Direct link to heading">â</a></h3><p>The <code>VM Live Migration</code> related configuration options are passed to each layer correspondingly.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="kubevirt">Kubevirt<a class="hash-link" href="#kubevirt" title="Direct link to heading">â</a></h4><p><a href="https://github.com/kubevirt/kubevirt/blob/d425593ae392111dab80403ef0cde82625e37653/pkg/virt-launcher/virtwrap/live-migration-source.go#L103" target="_blank" rel="noopener noreferrer">https://github.com/kubevirt/kubevirt/blob/d425593ae392111dab80403ef0cde82625e37653/pkg/virt-launcher/virtwrap/live-migration-source.go#L103</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;libvirt.org/go/libvirt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func generateMigrationFlags(isBlockMigration, migratePaused bool, options *cmdclient.MigrationOptions) libvirt.DomainMigrateFlags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if options.AllowAutoConverge {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        migrateFlags |= libvirt.MIGRATE_AUTO_CONVERGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if options.AllowPostCopy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        migrateFlags |= libvirt.MIGRATE_POSTCOPY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="go-package-libvirt">Go Package Libvirt<a class="hash-link" href="#go-package-libvirt" title="Direct link to heading">â</a></h4><p><a href="https://pkg.go.dev/libvirt.org/go/libvirt" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/libvirt.org/go/libvirt</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">const (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MIGRATE_AUTO_CONVERGE                 = DomainMigrateFlags(C.VIR_MIGRATE_AUTO_CONVERGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MIGRATE_RDMA_PIN_ALL                  = DomainMigrateFlags(C.VIR_MIGRATE_RDMA_PIN_ALL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MIGRATE_POSTCOPY                      = DomainMigrateFlags(C.VIR_MIGRATE_POSTCOPY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="libvirt">Libvirt<a class="hash-link" href="#libvirt" title="Direct link to heading">â</a></h4><p><a href="https://github.com/libvirt/libvirt/blob/bfe53e9145cd5996a791c5caff0686572b850f82/include/libvirt/libvirt-domain.h#L1030" target="_blank" rel="noopener noreferrer">https://github.com/libvirt/libvirt/blob/bfe53e9145cd5996a791c5caff0686572b850f82/include/libvirt/libvirt-domain.h#L1030</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    /* Enable algorithms that ensure a live migration will eventually converge.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This usually means the domain will be slowed down to make sure it does</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * not change its memory faster than a hypervisor can transfer the changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * memory to the destination host. VIR_MIGRATE_PARAM_AUTO_CONVERGE_*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * parameters can be used to tune the algorithm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Since: 1.2.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VIR_MIGRATE_AUTO_CONVERGE = (1 &lt;&lt; 13),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /* Setting the VIR_MIGRATE_POSTCOPY flag tells libvirt to enable post-copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * migration. However, the migration will start normally and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * virDomainMigrateStartPostCopy needs to be called to switch it into the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * post-copy mode. See virDomainMigrateStartPostCopy for more details.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Since: 1.3.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VIR_MIGRATE_POSTCOPY = (1 &lt;&lt; 15),</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/virtual-machine">virtual machine</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/vm">VM</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/live-migration">live migration</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/policy">policy</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/strategy">strategy</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/configuration">configuration</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/use_rook_ceph_external_storage">Use Rook Ceph External Storage with Harvester</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-23T00:00:00.000Z" itemprop="datePublished">August 23, 2023</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/futuretea" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/futuretea.png" alt="Hang Yu"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/futuretea" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Hang Yu</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Starting with Harvester v1.2.0, it offers the capability to install a Container Storage Interface (CSI) in your Harvester cluster. This allows you to leverage external storage for the Virtual Machine&#x27;s non-system data disk, giving you the flexibility to use different drivers tailored for specific needs, whether it&#x27;s for performance optimization or seamless integration with your existing in-house storage solutions.</p><p>It&#x27;s important to note that, despite this enhancement, the provisioner for the Virtual Machine (VM) image in Harvester still relies on Longhorn. Prior to version 1.2.0, Harvester exclusively supported Longhorn for storing VM data and did not offer support for external storage as a destination for VM data.</p><p>One of the options for integrating external storage with Harvester is Rook, an open-source cloud-native storage orchestrator. Rook provides a robust platform, framework, and support for Ceph storage, enabling seamless integration with cloud-native environments.</p><p><a href="https://ceph.io" target="_blank" rel="noopener noreferrer">Ceph</a> is a software-defined distributed storage system that offers versatile storage capabilities, including file, block, and object storage. It is designed for large-scale production clusters and can be deployed effectively in such environments.</p><p><a href="https://rook.io" target="_blank" rel="noopener noreferrer">Rook</a> simplifies the deployment and management of Ceph, offering self-managing, self-scaling, and self-healing storage services. It leverages Kubernetes resources to automate the deployment, configuration, provisioning, scaling, upgrading, and monitoring of Ceph.</p><p>In this article, we will walk you through the process of installing, configuring, and utilizing <a href="https://rook.io/docs/rook/v1.12/Getting-Started/intro/" target="_blank" rel="noopener noreferrer">Rook</a> to use storage from an <a href="https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/" target="_blank" rel="noopener noreferrer">existing external Ceph cluster</a> as a data disk for a VM within the Harvester environment.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-harvester-cluster">Install Harvester Cluster<a class="hash-link" href="#install-harvester-cluster" title="Direct link to heading">â</a></h2><p>Harvester&#x27;s operating system follows an immutable design, meaning that most OS files revert to their pre-configured state after a reboot. To accommodate Rook Ceph&#x27;s requirements, you need to add specific persistent paths to the <code>os.persistentStatePaths</code> section in the <a href="https://docs.harvesterhci.io/dev/install/harvester-configuration#ospersistent_state_paths" target="_blank" rel="noopener noreferrer">Harvester configuration</a>. These paths include:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">os</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">persistent_state_paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/lib/rook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/lib/ceph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">modules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> rbd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nbd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After the cluster is installed, refer to <a href="https://docs.harvesterhci.io/v1.1/faq#how-can-i-access-the-kubeconfig-file-of-the-harvester-cluster" target="_blank" rel="noopener noreferrer">How can I access the kubeconfig file of the Harvester cluster?</a> to get the kubeconfig of the Harvester cluster.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-rook-to-harvester">Install Rook to Harvester<a class="hash-link" href="#install-rook-to-harvester" title="Direct link to heading">â</a></h2><p>Install Rook to the Harvester cluster by referring to <a href="https://rook.io/docs/rook/v1.12/Getting-Started/quickstart/" target="_blank" rel="noopener noreferrer">Rook Quickstart</a>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -fsSLo rook.tar.gz https://github.com/rook/rook/archive/refs/tags/v1.12.2.tar.gz </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -zxf rook.tar.gz </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> rook-1.12.2/deploy/examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># apply configurations ref: https://rook.github.io/docs/rook/v1.12/Getting-Started/example-configurations/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f crds.yaml -f common.yaml -f operator.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n rook-ceph </span><span class="token function" style="color:#d73a49">wait</span><span class="token plain"> --for</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Available deploy rook-ceph-operator --timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">10m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-an-existing-external-ceph-cluster">Using an existing external Ceph cluster<a class="hash-link" href="#using-an-existing-external-ceph-cluster" title="Direct link to heading">â</a></h2><ol><li>Run the python script <code>create-external-cluster-resources.py</code> in the <a href="https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/" target="_blank" rel="noopener noreferrer">existing external Ceph cluster</a> for creating all users and keys.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># script help ref: https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/#1-create-all-users-and-keys</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -s https://raw.githubusercontent.com/rook/rook/v1.12.2/deploy/examples/create-external-cluster-resources.py </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> create-external-cluster-resources.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 create-external-cluster-resources.py --rbd-data-pool-name </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pool_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --namespace rook-ceph-external --format </span><span class="token function" style="color:#d73a49">bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="2"><li>Copy the Bash output.</li></ol><p>Example output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export NAMESPACE=rook-ceph-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_FSID=b3b47828-4c60-11ee-be38-51902f85c805</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_USERNAME=client.healthchecker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_CEPH_MON_DATA=ceph-1=192.168.5.99:6789</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_USER_SECRET=AQDd6/dkFyu/IhAATv/uCMbHtWk4AYK2KXzBhQ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_DASHBOARD_LINK=https://192.168.5.99:8443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_NODE_SECRET=AQDd6/dk2HsjIxAA06Yw9UcOg0dfwV/9IFBRhA==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_NODE_SECRET_NAME=csi-rbd-node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_PROVISIONER_SECRET=AQDd6/dkEY1kIxAAAzrXZnVRf4x+wDUz1zyaQg==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_PROVISIONER_SECRET_NAME=csi-rbd-provisioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MONITORING_ENDPOINT=192.168.5.99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MONITORING_ENDPOINT_PORT=9283</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RBD_POOL_NAME=test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RGW_POOL_PREFIX=default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="3"><li>Consume the external Ceph cluster resources on the Harvester cluster.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Paste the above output from create-external-cluster-resources.py into import-env.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> import-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> import-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># this script will create a StorageClass ceph-rbd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> import-external-cluster.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f common-external.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f cluster-external.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># wait for all pods to become Ready</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;kubectl --namespace rook-ceph get pods&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="4"><li>Create the VolumeSnapshotClass <code>csi-rbdplugin-snapclass-external</code>.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">./csi/rbd/snapshotclass-external.yaml </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: snapshot.storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: VolumeSnapshotClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: csi-rbdplugin-snapclass-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">driver: rook-ceph.rbd.csi.ceph.com # driver:namespace:operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  clusterID: rook-ceph-external # namespace:cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  csi.storage.k8s.io/snapshotter-secret-name: rook-csi-rbd-provisioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  csi.storage.k8s.io/snapshotter-secret-namespace: rook-ceph-external # namespace:cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">deletionPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ./csi/rbd/snapshotclass-external.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-harvester-cluster">Configure Harvester Cluster<a class="hash-link" href="#configure-harvester-cluster" title="Direct link to heading">â</a></h2><p>Before you can make use of Harvester&#x27;s <strong>Backup &amp; Snapshot</strong> features, you need to set up some essential configurations through the Harvester <a href="https://docs.harvesterhci.io/v1.2/advanced/settings#csi-driver-config" target="_blank" rel="noopener noreferrer">csi-driver-config</a> setting. To set up these configurations, follow these steps:</p><ol><li>Login to the Harvester UI, then navigate to <strong>Advanced</strong> &gt; <strong>Settings</strong>.</li><li>Find and select <strong>csi-driver-config</strong>, and then click on the <strong>â®</strong> &gt; <strong>Edit Setting</strong> to access the configuration options.</li><li>In the settings, set the <strong>Provisioner</strong> to <code>rook-ceph.rbd.csi.ceph.com</code>.</li><li>Next, specify the <strong>Volume Snapshot Class Name</strong> as <code>csi-rbdplugin-snapclass-external</code>. This setting points to the name of the <code>VolumeSnapshotClass</code> used for creating volume snapshots or VM snapshots.</li><li>Similarly, set the <strong>Backup Volume Snapshot Class Name</strong> to <code>csi-rbdplugin-snapclass-external</code>. This corresponds to the name of the <code>VolumeSnapshotClass</code> responsible for creating VM backups.</li></ol><p><img loading="lazy" alt="csi-driver-config-external" src="/assets/images/csi-driver-config-external-59b885aff7095a9bda897ed59f289d82.png" width="3824" height="1848"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="use-rook-ceph-in-harvester">Use Rook Ceph in Harvester<a class="hash-link" href="#use-rook-ceph-in-harvester" title="Direct link to heading">â</a></h2><p>After successfully configuring these settings, you can proceed to utilize the Rook Ceph StorageClass, which is named <code>rook-ceph-block</code> for the internal Ceph cluster or named <code>ceph-rbd</code> for the external Ceph cluster. You can apply this StorageClass when creating an empty volume or adding a new block volume to a VM, enhancing your Harvester cluster&#x27;s storage capabilities.</p><p>With these configurations in place, your Harvester cluster is ready to make the most of the Rook Ceph storage integration.</p><p><img loading="lazy" alt="rook-ceph-volume-external" src="/assets/images/rook-ceph-volume-external-974d73b9b863e95495c7b119d2c50954.png" width="3824" height="1848"></p><p><img loading="lazy" alt="rook-ceph-vm-external" src="/assets/images/rook-ceph-vm-external-4c1b4f6b6a6676e13d312cac3498d786.png" width="3824" height="1848"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/rook">rook</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/ceph">ceph</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/csi">csi</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-21T00:00:00.000Z" itemprop="datePublished">August 21, 2023</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/yaocw2020" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://avatars.githubusercontent.com/u/7421463?s=400&amp;v=4" alt="Canwu Yao"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yaocw2020" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Canwu Yao</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>As <strong>Harvester v1.2.0</strong> is released, a new Harvester cloud provider version <strong>0.2.2</strong> is integrated into RKE2 <strong>v1.24.15+rke2r1</strong>, <strong>v1.25.11+rke2r1</strong>,  <strong>v1.26.6+rke2r1</strong>, <strong>v1.27.3+rke2r1</strong>, and newer versions.</p><p>With Harvester v1.2.0, the new Harvester cloud provider offers enhanced load balancing capabilities for guest Kubernetes services. Specifically, it introduces the Harvester IP Pool feature, a built-in IP address management (IPAM) solution for the Harvester load balancer. It allows you to define an IP pool specific to a particular guest cluster by specifying the guest cluster name. For example, you can create an IP pool exclusively for the guest cluster named cluster2:</p><p><img loading="lazy" alt="image" src="/assets/images/ippoolforcluster2-264c61833ccd9a79fb03dd73930d2401.png" width="3050" height="972"></p><p>However, after upgrading, the feature is not automatically compatible with existing guest Kubernetes clusters, as they do not pass the correct cluster name to the Harvester cloud provider. Refer to <a href="https://github.com/harvester/harvester/issues/4232" target="_blank" rel="noopener noreferrer">issue 4232</a> for more details. Users can manually upgrade the Harvester cloud provider using Helm as a workaround and provide the correct cluster name after upgrading. However, this would result in a change in the load balancer IPs. </p><p>This article outlines a workaround that allows you to leverage the new IP pool feature while keeping the load balancer IPs unchanged.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">â</a></h2><ul><li><p>Download the Harvester kubeconfig file from the Harvester UI. If you have imported Harvester into Rancher, do not use the kubeconfig file from the Rancher UI. Refer to <a href="https://docs.harvesterhci.io/v1.1/faq#how-can-i-access-the-kubeconfig-file-of-the-harvester-cluster" target="_blank" rel="noopener noreferrer">Access Harvester Cluster</a> to get the desired one.</p></li><li><p>Download the kubeconfig file for the guest Kubernetes cluster you plan to upgrade. Refer to <a href="https://ranchermanager.docs.rancher.com/how-to-guides/new-user-guides/manage-clusters/access-clusters/use-kubectl-and-kubeconfig#accessing-clusters-with-kubectl-from-your-workstation" target="_blank" rel="noopener noreferrer">Accessing Clusters with kubectl from Your Workstation</a> for instructions on how to download the kubeconfig file.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="steps-to-keep-load-balancer-ip">Steps to Keep Load Balancer IP<a class="hash-link" href="#steps-to-keep-load-balancer-ip" title="Direct link to heading">â</a></h2><ol><li><p>Execute the following script before upgrading.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://raw.githubusercontent.com/harvester/harvesterhci.io/main/kb/2023-08-21/keepip.sh | sh -s before_upgrade &lt;Harvester-kubeconfig-path&gt; &lt;guest-cluster-kubeconfig-path&gt; &lt;guest-cluster-name&gt; &lt;guest-cluster-nodes-namespace&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><code>&lt;Harvester-kubeconfig-path&gt;</code>: Path to the Harvester kubeconfig file.</li><li><code>&lt;guest-cluster-kubeconfig-path&gt;</code>: Path to the kubeconfig file of your guest Kubernetes cluster.</li><li><code>&lt;guest-cluster-name&gt;</code>: Name of your guest cluster.</li><li><code>&lt;guest-cluster-nodes-namespace&gt;</code>: Namespace where the VMs of the guest cluster are located.</li></ul><p>The script will help users copy the DHCP information to the service annotation and modify the IP pool allocated history to make sure the IP is unchanged.</p><p><img loading="lazy" alt="image" src="/assets/images/before-upgrade-32da6d40ebe06324de4a258174ac6220.png" width="2196" height="780"></p><p>After executing the script, the load balancer service with DHCP mode will be annotated with the DHCP information. For example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kube-vip.io/hwaddr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">6c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">4f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token datetime number" style="color:#36acaa">18:68</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kube-vip.io/requestedIP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 172.19.105.215</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>As for the load balancer service with pool mode, the IP pool allocated history will be modified as the new load balancer name. For example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> loadbalancer.harvesterhci.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IPPool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">allocatedHistory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">192.168.100.2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default/cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">default</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lb1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ddc13071 </span><span class="token comment" style="color:#999988;font-style:italic"># replace the new load balancer name</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Add network selector for the pool.</p><p>For example, the following cluster is under the VM network <code>default/mgmt-untagged</code>. The network selector should be <code>default/mgmt-untagged</code>.</p><p><img loading="lazy" alt="image" src="/assets/images/network-ba7294269bf230843a11803191e20f1e.png" width="3498" height="1980"></p><p><img loading="lazy" alt="image" src="/assets/images/network-selector-0f179a6c97e2fa3621bcaadd8c09e39d.png" width="3054" height="1232"></p></li><li><p>Upgrade the RKE2 cluster in the Rancher UI and select the new version.</p><p><img loading="lazy" alt="image" src="/assets/images/upgrade-6356d7891793f5c94e25da1f6aa22944.png" width="3502" height="2052"></p></li><li><p>Execute the script after upgrading.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://raw.githubusercontent.com/harvester/harvesterhci.io/main/kb/2023-08-21/keepip.sh | sh -s after_upgrade &lt;Harvester-kubeconfig-path&gt; &lt;guest-cluster-kubeconfig-path&gt; &lt;guest-cluster-name&gt; &lt;guest-cluster-nodes-namespace&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><img loading="lazy" alt="image" src="/assets/images/before-upgrade-32da6d40ebe06324de4a258174ac6220.png" width="2196" height="780"></p><p> In this step, the script wraps the operations to upgrade the Harvester cloud provider to set the cluster name. After the Harvester cloud provider is running, the new Harvester load balancers will be created with the unchanged IPs.</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/load-balancer">load balancer</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/cloud-provider">cloud provider</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/ip-pool">ip pool</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/upgrade">upgrade</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/install_netapp_trident_csi">Using NetApp Storage on Harvester</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-11T00:00:00.000Z" itemprop="datePublished">August 11, 2023</time> Â· <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Jeff Radick</span></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This article covers instructions for installing the Netapp Astra Trident CSI driver into a Harvester cluster, which enables NetApp storage systems to store storage volumes usable by virtual machines running in Harvester.</p><p>The NetApp storage will be an option in addition to the normal Longhorn storage; it will not replace Longhorn. Virtual machine images will still be stored using Longhorn.</p><p>This has been tested with Harvester 1.2.0 and Trident v23.07.0.</p><p>This procedure only works to access storage via iSCSI, not NFS.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>3rd party storage classes (including those based on Trident) can only be used for non-boot volumes of Harvester VMs.</p></div></div><h1>Detailed Instructions</h1><p>We assume that before beginning this procedure, a Harvester cluster and a NetApp ONTAP storage system are both installed and configured for use.</p><p>Most of these steps can be performed on any system with the <code>helm</code> and <code>kubectl</code> commands installed and network connectivity to the management port of the Harvester cluster.  Let&#x27;s call this your workstation.  Certain steps must be performed on one or more cluster nodes themselves.  The steps described below should be done on your workstation unless otherwise indicated.</p><p>The last step (enabling multipathd) should be done on all nodes after the Trident CSI has been installed.</p><p>Certain parameters of your installation will require modification of details in the examples in the procedure given below. Those which you may wish to modify include:</p><ul><li>The namespace.  <code>trident</code> is used as the namespace in the examples, but you may prefer to use another.</li><li>The name of the deployment. <code>mytrident</code> is used but you can change this to something else.</li><li>The management IP address of the ONTAP storage system</li><li>Login credentials (username and password) of the ONTAP storage system</li></ul><p>The procedure is as follows.</p><ol><li><p>Read the NetApp Astra Trident documentation:</p><ul><li><a href="https://docs.netapp.com/us-en/trident/" target="_blank" rel="noopener noreferrer">https://docs.netapp.com/us-en/trident/</a></li><li><a href="https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-operator.html" target="_blank" rel="noopener noreferrer">https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-operator.html</a></li><li><a href="https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-helm.html#deploy-the-trident-operator-and-install-astra-trident-using-helm" target="_blank" rel="noopener noreferrer">https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-helm.html#deploy-the-trident-operator-and-install-astra-trident-using-helm</a></li></ul><p>The simplest method is to install using Helm; that process is described here.</p></li><li><p>Download the KubeConfig from the Harvester cluster.</p><ul><li>Open the web UI for your Harvester cluster</li><li>In the lower left corner, click the &quot;Support&quot; link.  This will take you to a &quot;Harvester Support&quot; page.</li><li>Click the button labeled &quot;Download KubeConfig&quot;.  This will download a your cluster config in a file called &quot;local.yaml&quot; by default.</li><li>Move this file to a convenient location and set your <code>KUBECONFIG</code> environment variable to the path of this file.</li></ul></li><li><p>Prepare the cluster for installation of the Helm chart.</p><p>Before starting installation of the helm chart, special authorization must be provided to enable certain modifications to be made during the installation.
This addresses the issue described here: <a href="https://github.com/NetApp/trident/issues/839" target="_blank" rel="noopener noreferrer">https://github.com/NetApp/trident/issues/839</a></p><ul><li><p>Put the following text into a file.  For this example we&#x27;ll call it <code>authorize_trident.yaml</code>.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">psa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> management.cattle.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> projects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> updatepsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">psa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">psa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Apply this manifest via the command <code>kubectl apply -f authorize_trident.yaml</code>.</p></li></ul></li><li><p>Install the helm chart.</p><ul><li><p>First you will need to add the Astra Trident Helm repository:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> netapp-trident https://netapp.github.io/trident-helm-chart</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Next, install the Helm chart.  This example uses <code>mytrident</code> as the deployment name, <code>trident</code> as the namespace, and 23.07.0 as the version number to install:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> mytrident netapp-trident/trident-operator --version </span><span class="token number" style="color:#36acaa">23.07</span><span class="token plain">.0 --create-namespace --namespace trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>The NetApp documentation describes variations on how you can do this.</p></li></ul></li><li><p>Download and extract the tridentctl command, which will be needed for the next few steps.</p><p>This and the next few steps need to be performed logged into a master node of the Harvester cluster, using root access.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -L -o trident-installer-23.07.0.tar.gz https://github.com/NetApp/trident/releases/download/v23.07.0/trident-installer-23.07.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -xf trident-installer-23.07.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> trident-installer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Install a backend.</p><p>This part is specific to Harvester.</p><ol><li><p>Put the following into a text file, for example /tmp/backend.yaml</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">backendName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default_backend_san</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">storageDriverName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ontap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">san</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">economy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">managementLIF</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 172.19.97.114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">svm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default_backend_san</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The LIF IP address, username, and password of this file
should be replaced with the management LIF and credentials
for the ONTAP system.</p></li><li><p>Create the backend</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./tridentctl create backend -f /tmp/backend.yaml -n trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Check that it is created</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./tridentctl get backend -n trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li><li><p>Define a StorageClass and SnapshotClass.</p><ol><li><p>Put the following into a file, for example <code>/tmp/storage.yaml</code></p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ontap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">san</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">economy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">provisioner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> csi.trident.netapp.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name=default_backend_san&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> snapshot.storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VolumeSnapshotClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> csi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">snapclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">driver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> csi.trident.netapp.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">deletionPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Apply the definitions:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f /tmp/storage.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li><li><p>Enable multipathd</p><p>The following is required to enable multipathd.
This must be done on every node of the Harvester cluster, using root access.
The preceding steps should only be done once on a single node.</p><ol><li><p>Create this file in <code>/oem/99_multipathd.yaml</code>:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Setup multipathd&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">systemctl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token key atrule" style="color:#00a4db">enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> multipathd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token key atrule" style="color:#00a4db">start</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> multipathd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Configure <code>multipathd</code> to exclude pathnames used by Longhorn.</p><p>This part is a little tricky.  <code>multipathd</code> will automatically discover
device names matching a certain pattern, and attempt to set up multipathing on them.
Unfortunately, Longhorn&#x27;s device names follow the same pattern, and
will not work correctly if <code>multipathd</code> tries to use those devices.</p><p>Therefore the file <code>/etc/multipath.conf</code> must be set up on each node
so as to prevent <code>multipathd</code> from touching any of the devices
that Longhorn will use.  Unfortunately, it is not possible to know
in advance which device names will be used until the volumes are attached
to a VM when the VM is started, or when the volumes are hot-added to a running VM.
The recommended method is to &quot;whitelist&quot; the Trident devices using device
properties rather than device naming.  The properties to allow are the
device vendor and product.  Here is an example of what you&#x27;ll want in <code>/etc/multipath.conf</code>:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">blacklist {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vendor &quot;!NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        product &quot;!LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blacklist_exceptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vendor &quot;NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        product &quot;LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> This example only works if NetApp is the only storage provider in the system for which <code>multipathd</code> must be used.  More complex environments will require more complex configuration.</p><p> Explicitly putting that content into <code>/etc/multipath.conf</code> will work when you start <code>multipathd</code> as described below, but the change in <code>/etc</code> will not persist across node reboots.  To solve that problem, you should add another file to <code>/oem</code> that will re-generate <code>/etc/multipath.conf</code> when the node reboots.  The following example will create the <code>/etc/multipath.conf</code> given in the example above, but may need to be modified for your environment if you have a more complex iSCSI configuration:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">stages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   initramfs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - name: &quot;Configure multipath blacklist and whitelist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       files:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - path: /etc/multipath.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         permissions: 0644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         owner: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         group: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         content: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           blacklist {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   vendor &quot;!NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   product &quot;!LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            blacklist_exceptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    vendor &quot;NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    product &quot;LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> Remember, this has to be done on every node.</p></li><li><p>Enable multipathd.</p><p>Adding the above files to <code>/oem</code> will take effect on the next reboot of the node; <code>multipathd</code> can be enabled immediately without rebooting the node using the following commands:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> multipathd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start multipathd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>  After the above steps, the <code>ontap-san-economy</code> storage class should be available when creating a volume for a Harvester VM.</p></li></ol></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-07-25T00:00:00.000Z" itemprop="datePublished">July 25, 2023</time> Â· <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/bk201.png" alt="Kiefer Chang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kiefer Chang</span></a></div><small class="avatar__subtitle" itemprop="description">Engineer Manager</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><strong>Harvester v1.2.0</strong>  introduces a new enhancement where Longhorn system-managed components in newly-deployed clusters are automatically assigned a <code>system-cluster-critical</code> priority class by default. However, when upgrading your Harvester clusters from previous versions, you may notice that Longhorn system-managed components do not have any priority class set.</p><p>This behavior is intentional and aimed at supporting zero-downtime upgrades. Longhorn does not allow changing the <code>priority-class</code> setting when attached volumes exist. For more details, please refer to <a href="https://longhorn.io/docs/1.4.3/advanced-resources/deploy/priority-class/#setting-priority-class-during-longhorn-installation" target="_blank" rel="noopener noreferrer">Setting Priority Class During Longhorn Installation</a>).</p><p>This article explains how to manually configure priority classes for Longhorn system-managed components after upgrading your Harvester cluster, ensuring that your Longhorn components have the appropriate priority class assigned and maintaining the stability and performance of your system.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="stop-all-virtual-machines">Stop all virtual machines<a class="hash-link" href="#stop-all-virtual-machines" title="Direct link to heading">â</a></h2><p>Stop all virtual machines (VMs) to detach all volumes. Please back up any work before doing this.</p><ol><li><p><a href="https://docs.harvesterhci.io/v1.1/troubleshooting/os#how-to-log-into-a-harvester-node" target="_blank" rel="noopener noreferrer">Login to a Harvester controller node and become root</a>.</p></li><li><p>Get all running VMs and write down their namespaces and names:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Alternatively, you can get this information by backing up the Virtual Machine Instance (VMI) manifests with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A -o json </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> vmi-backup.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Shut down all VMs. Log in to all running VMs and shut them down gracefully (recommended). Or use the following command to send shutdown signals to all VMs:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A -o json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq -r </span><span class="token string" style="color:#e3116c">&#x27;.items[] | [.metadata.name, .metadata.namespace] | @tsv&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">IFS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">$&#x27;</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token plain"> </span><span class="token builtin class-name">read</span><span class="token plain"> -r name namespace</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$name</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Stop </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      virtctl stop </span><span class="token variable" style="color:#36acaa">$name</span><span class="token plain"> -n </span><span class="token variable" style="color:#36acaa">$namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>  You can also stop all VMs from the Harvester UI:</p><ol><li>Go to the <strong>Virtual Machines</strong> page.</li><li>For each VM, select <strong>â®</strong> &gt; <strong>Stop</strong>.</li></ol></div></div></li><li><p>Ensure there are no running VMs:</p><p>Run the command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above command must return:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">No resources found</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-down-monitoring-pods">Scale down monitoring pods<a class="hash-link" href="#scale-down-monitoring-pods" title="Direct link to heading">â</a></h2><ol><li><p>Scale down the Prometheus deployment. Run the following command and wait for all Prometheus pods to terminate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system prometheus/rancher-monitoring-prometheus --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 0}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/prometheus-rancher-monitoring-prometheus</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">prometheus.monitoring.coreos.com/rancher-monitoring-prometheus patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 0 pods at revision prometheus-rancher-monitoring-prometheus-cbf6bd5f7...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the AlertManager deployment. Run the following command and wait for all AlertManager pods to terminate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system alertmanager/rancher-monitoring-alertmanager --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 0}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/alertmanager-rancher-monitoring-alertmanager</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager.monitoring.coreos.com/rancher-monitoring-alertmanager patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 0 pods at revision alertmanager-rancher-monitoring-alertmanager-c8c459dff...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the Grafana deployment. Run the following command and wait for all Grafana pods to terminate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> deployment/rancher-monitoring-grafana -n cattle-monitoring-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system deployment/rancher-monitoring-grafana</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/rancher-monitoring-grafana scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;rancher-monitoring-grafana&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-down-vm-import-controller-pods">Scale down vm-import-controller pods<a class="hash-link" href="#scale-down-vm-import-controller-pods" title="Direct link to heading">â</a></h2><ol><li><p>Check if the <a href="https://docs.harvesterhci.io/v1.1/advanced/vmimport" target="_blank" rel="noopener noreferrer"><code>vm-import-controller</code></a> addon is enabled and configured with a persistent volume with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pvc -n harvester-system harvester-vm-import-controller</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If the above command returns an output like this, you must scale down the <code>vm-import-controller</code> pod. Otherwise, you can skip the following step.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS         AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">harvester-vm-import-controller   Bound    pvc-eb23e838-4c64-4650-bd8f-ba7075ab0559   200Gi      RWO            harvester-longhorn   2m53s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the <code>vm-import-controller</code> pods with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> deployment/harvester-vm-import-controller -n harvester-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n harvester-system deployment/harvester-vm-import-controller</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/harvester-vm-import-controller scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;harvester-vm-import-controller&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="set-the-priority-class-setting">Set the <code>priority-class</code> setting<a class="hash-link" href="#set-the-priority-class-setting" title="Direct link to heading">â</a></h2><ol><li><p>Before applying the <code>priority-class</code> setting, you need to verify all volumes are detached. Run the following command to verify the <code>STATE</code> of each volume is <code>detached</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get volumes.longhorn.io -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Verify the output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE         NAME                                       STATE      ROBUSTNESS   SCHEDULED   SIZE           NODE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-5743fd02-17a3-4403-b0d3-0e9b401cceed   detached   unknown                  5368709120            15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-7e389fe8-984c-4049-9ba8-5b797cb17278   detached   unknown                  53687091200           15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-8df64e54-ecdb-4d4e-8bab-28d81e316b8b   detached   unknown                  2147483648            15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-eb23e838-4c64-4650-bd8f-ba7075ab0559   detached   unknown                  214748364800          11m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Set the <code>priority-class</code> setting with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n longhorn-system settings.longhorn.io priority-class --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;value&quot;: &quot;system-cluster-critical&quot;}&#x27;</span><span class="token plain"> --type merge</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Longhorn system-managed pods will restart and then you need to check if all the system-managed components have a priority class set:</p><p>Get the value of the priority class <code>system-cluster-critical</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get priorityclass system-cluster-critical</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Verify the output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                      VALUE        GLOBAL-DEFAULT   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-cluster-critical   2000000000   false            15d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Use the following command to get pods&#x27; priority in the <code>longhorn-system</code> namespace:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n longhorn-system -o custom-columns</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Name&quot;</span><span class="token plain">:metadata.name,</span><span class="token string" style="color:#e3116c">&quot;Priority&quot;</span><span class="token plain">:.spec.priority</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Verify all system-managed components&#x27; pods have the correct priority. System-managed components include:</p><ul><li><code>csi-attacher</code></li><li><code>csi-provisioner</code></li><li><code>csi-resizer</code></li><li><code>csi-snapshotter</code></li><li><code>engine-image-ei</code></li><li><code>instance-manager-e</code></li><li><code>instance-manager-r</code></li><li><code>longhorn-csi-plugin</code></li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-up-vm-import-controller-pods">Scale up vm-import-controller pods<a class="hash-link" href="#scale-up-vm-import-controller-pods" title="Direct link to heading">â</a></h2><p>If you scale down the <code>vm-import-controller</code> pods, you must scale it up again. </p><ol><li><p>Scale up the <code>vm-import-controller</code> pod. Run the command: </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> deployment/harvester-vm-import-controller -n harvester-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n harvester-system deployment/harvester-vm-import-controller</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/harvester-vm-import-controller scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for deployment &quot;harvester-vm-import-controller&quot; rollout to finish: 0 of 1 updated replicas are available...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;harvester-vm-import-controller&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Verify <code>vm-import-controller</code> is running using the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --selector app.kubernetes.io/instance</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vm-import-controller -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this, the pod&#x27;s <code>STATUS</code> must be <code>Running</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE          NAME                                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">harvester-system   harvester-vm-import-controller-6bd8f44f55-m9k86   1/1     Running   0          4m53s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-up-monitoring-pods">Scale up monitoring pods<a class="hash-link" href="#scale-up-monitoring-pods" title="Direct link to heading">â</a></h2><ol><li><p>Scale up the Prometheus deployment. Run the following command and wait for all Prometheus pods to roll out:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system prometheus/rancher-monitoring-prometheus --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 1}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/prometheus-rancher-monitoring-prometheus</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">prometheus.monitoring.coreos.com/rancher-monitoring-prometheus patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for 1 pods to be ready...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 1 pods at revision prometheus-rancher-monitoring-prometheus-cbf6bd5f7...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the AlertManager deployment. Run the following command and wait for all AlertManager pods to roll out:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system alertmanager/rancher-monitoring-alertmanager --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 1}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/alertmanager-rancher-monitoring-alertmanager</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager.monitoring.coreos.com/rancher-monitoring-alertmanager patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for 1 pods to be ready...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 1 pods at revision alertmanager-rancher-monitoring-alertmanager-c8bd4466c...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the Grafana deployment. Run the following command and wait for all Grafana pods to roll out:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> deployment/rancher-monitoring-grafana -n cattle-monitoring-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system deployment/rancher-monitoring-grafana</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/rancher-monitoring-grafana scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for deployment &quot;rancher-monitoring-grafana&quot; rollout to finish: 0 of 1 updated replicas are available...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;rancher-monitoring-grafana&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="start-virtual-machines">Start virtual machines<a class="hash-link" href="#start-virtual-machines" title="Direct link to heading">â</a></h2><ol><li><p>Start a VM with the command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">virtctl start </span><span class="token variable" style="color:#36acaa">$name</span><span class="token plain"> -n </span><span class="token variable" style="color:#36acaa">$namespace</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Replace <code>$name</code> with the VM&#x27;s name and <code>$namespace</code> with the VM&#x27;s namespace. You can list all virtual machines with the command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vms -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p> You can also stop all VMs from the Harvester UI:</p><ol><li>Go to the <strong>Virtual Machines</strong> page.</li><li>For each VM, select <strong>â®</strong> &gt; <strong>Start</strong>.</li></ol></div></div><p>Alternatively, you can start all running VMs with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> vmi-backup.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq -r </span><span class="token string" style="color:#e3116c">&#x27;.items[] | [.metadata.name, .metadata.namespace] | @tsv&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">IFS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">$&#x27;</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token plain"> </span><span class="token builtin class-name">read</span><span class="token plain"> -r name namespace</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$name</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Start </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      virtctl start </span><span class="token variable" style="color:#36acaa">$name</span><span class="token plain"> -n </span><span class="token variable" style="color:#36acaa">$namespace</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/priority-class">priority class</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/package_your_own_toolbox_image">Package your own Toolbox Image</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-07-06T00:00:00.000Z" itemprop="datePublished">July 6, 2023</time> Â· <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/Vicente-Cheng.png" alt="Vicente Cheng"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Vicente Cheng</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Harvester OS is designed as an immutable operating system, which means you cannot directly install additional packages on it. While there is a way to <a href="https://docs.harvesterhci.io/dev/troubleshooting/os#how-can-i-install-packages-why-are-some-paths-read-only" target="_blank" rel="noopener noreferrer">install packages</a>, it is strongly advised against doing so, as it may lead to system instability.</p><p>If you only want to debug with the system, the preferred way is to package the toolbox image with all the needed packages. </p><p>This article shares how to package your toolbox image and how to install any packages on the toolbox image that help you debug the system.</p><p>For example, if you want to analyze a storage performance issue, you can install <code>blktrace</code> on the toolbox image.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="create-a-dockerfile">Create a Dockerfile<a class="hash-link" href="#create-a-dockerfile" title="Direct link to heading">â</a></h2><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM opensuse/leap:15.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Install blktrace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN </span><span class="token function" style="color:#d73a49">zypper</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> -y </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blktrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN </span><span class="token function" style="color:#d73a49">zypper</span><span class="token plain"> clean --all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="build-the-image-and-push">Build the image and push<a class="hash-link" href="#build-the-image-and-push" title="Direct link to heading">â</a></h2><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># assume you are in the directory of Dockerfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t harvester/toolbox:dev </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naming to docker.io/harvester/toolbox:dev </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> push harvester/toolbox:dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d4b76d0683d4: Pushed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a605baa225e2: Pushed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9e9058bdf63c: Layer already exists </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After you build and push the image, you can run the toolbox using this image to trace storage performance.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="run-the-toolbox">Run the toolbox<a class="hash-link" href="#run-the-toolbox" title="Direct link to heading">â</a></h2><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># use `privileged` flag only when you needed. blktrace need debugfs, so I add extra mountpoint.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it --privileged -v /sys/kernel/debug/:/sys/kernel/debug/ --rm harvester/toolbox:dev </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># test blktrace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6ffa8eda3aaf:/ $ blktrace -d /dev/nvme0n1 -o - </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> blkparse -i -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3414</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020814875</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  Q  WS </span><span class="token number" style="color:#36acaa">2414127984</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3415</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020815190</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  G  WS </span><span class="token number" style="color:#36acaa">2414127984</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3416</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020815989</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  C  WS </span><span class="token number" style="color:#36acaa">3206896544</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3417</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020816652</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  C  WS </span><span class="token number" style="color:#36acaa">2140319184</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3418</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020817992</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  P   N </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3419</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020818227</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  U   N </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3420</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020818437</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  D  WS </span><span class="token number" style="color:#36acaa">2414127984</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3421</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020821826</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  Q  WS </span><span class="token number" style="color:#36acaa">1743934904</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">259,0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3422</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0.020822150</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34084</span><span class="token plain">  G  WS </span><span class="token number" style="color:#36acaa">1743934904</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fio</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/debug">debug</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/container">container</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-01T00:00:00.000Z" itemprop="datePublished">February 1, 2023</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/Vicente-Cheng.png" alt="Vicente Cheng"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Vicente Cheng</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In earlier versions of Harvester (v1.0.3 and prior), Longhorn volumes may get corrupted during the replica rebuilding process (reference: <a href="https://longhorn.io/kb/troubleshooting-volume-filesystem-corruption/#solution" target="_blank" rel="noopener noreferrer">Analysis: Potential Data/Filesystem Corruption</a>). In Harvester v1.1.0 and later versions, the Longhorn team has fixed this issue. This article covers manual steps you can take to scan the VM&#x27;s filesystem and repair it if needed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="stop-the-vm-and-backup-volume">Stop The VM And Backup Volume<a class="hash-link" href="#stop-the-vm-and-backup-volume" title="Direct link to heading">â</a></h2><p>Before you scan the filesystem, it is recommend you back up the volume first. For an example, refer to the following steps to stop the VM and backup the volume.</p><ul><li>Find the target VM.</li></ul><p><img loading="lazy" alt="finding the target VM" src="/assets/images/finding_the_target_vm-c3f5c227fdeda94499a32e880a302e80.png" width="2560" height="880"></p><ul><li>Stop the target VM.</li></ul><p><img loading="lazy" alt="Stop the target VM" src="/assets/images/stop_the_target_vm-35b68914885fd42f4b7310aa849f944f.png" width="2546" height="856"></p><p>The target VM is stopped and the related volumes are detached. Now go to the Longhorn UI to backup this volume.</p><ul><li>Enable <code>Developer Tools &amp; Features</code> (Preferences -&gt; Enable Developer Tools &amp; Features).</li></ul><p><img loading="lazy" alt="Preferences then enable developer mode" src="/assets/images/preferences_enable_developer_mode-1379680f02f9980091177736ed7ce523.png" width="2570" height="1090">
<img loading="lazy" alt="Enable the developer mode" src="/assets/images/enable_the_developer_mode-8dffb1796b8e5da9863d6c69ad7f0209.png" width="2760" height="350"></p><ul><li>Click the <code>â®</code> button and select <strong>Edit Config</strong> to edit the config page of the VM.</li></ul><p><img loading="lazy" alt="goto edit config page of VM" src="/assets/images/goto_vm_edit_config_page-52e958d3a5e04c912e77615d3ab05616.png" width="2526" height="964"></p><ul><li>Go to the <code>Volumes</code> tab and select <code>Check volume details.</code></li></ul><p><img loading="lazy" alt="link to longhorn volume page" src="/assets/images/link_to_longhorn_volume-ced67ce270fd55fa7ff5a73c651ae940.png" width="2522" height="1372"></p><ul><li>Click the dropdown menu on the right side and select &#x27;Attach&#x27; to attach the volume again. </li></ul><p><img loading="lazy" alt="attach this volume again" src="/assets/images/attach_this_volume_again-f008c1d56b9cdfa2b141e30093cc51fe.png" width="2972" height="1358"></p><ul><li>Select the attached node. </li></ul><p><img loading="lazy" alt="choose the attached node" src="/assets/images/choose_the_attached_node-cde38647a09abf50189b40f5a37da9cb.png" width="2964" height="1362"></p><ul><li>Check the volume attached under <code>Volume Details</code> and select <code>Take Snapshot</code> on this volume page.</li></ul><p><img loading="lazy" alt="take snapshot on volume page" src="/assets/images/take_snapshot_on_volume_page-fe966d238b47aea3360b6f5c55664846.png" width="2976" height="1358"></p><ul><li>Confirm that the snapshot is ready.</li></ul><p><img loading="lazy" alt="check the snapshot is ready" src="/assets/images/check_the_snapshot_is_ready-7f0716b1b699c668c11ad5b5b46596b0.png" width="2968" height="1356"></p><p>Now that you completed the volume backup, you need to scan and repair the root filesystem.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="scanning-the-root-filesystem-and-repairing">Scanning the root filesystem and repairing<a class="hash-link" href="#scanning-the-root-filesystem-and-repairing" title="Direct link to heading">â</a></h2><p>This section will introduce how to scan the filesystem (e.g., XFS, EXT4) using related tools.</p><p>Before scanning, you need to know the filesystem&#x27;s device/partition.</p><ul><li>Identify the filesystem&#x27;s device by checking the major and minor numbers of that device.</li></ul><ol><li><p>Obtain the major and minor numbers from the listed volume information.</p><p>In the following example, the volume name is <code>pvc-ea7536c0-301f-479e-b2a2-e40ddc864b58</code>.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">harvester-node-0:~ # ls /dev/longhorn/pvc-ea7536c0-301f-479e-b2a2-e40ddc864b58 -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brw-rw---- 1 root root 8, 0 Oct 23 14:43 /dev/longhorn/pvc-ea7536c0-301f-479e-b2a2-e40ddc864b58</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The output indicates that the major and minor numbers are <code>8:0</code>.</p></li><li><p>Obtain the device name from the output of the <code>lsblk</code> command.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">harvester-node-0:~ # lsblk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop0    7:0    0     3G  1 loop /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sda      8:0    0    40G  0 disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ââsda1   8:1    0     2M  0 part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ââsda2   8:2    0    20M  0 part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ââsda3   8:3    0    40G  0 part</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The output indicates that <code>8:0</code> are the major and minor numbers of the device named <code>sda</code>. Therefore, <code>/dev/sda</code> is related to the volume named <code>pvc-ea7536c0-301f-479e-b2a2-e40ddc864b58</code>.</p></li></ol><ul><li>You should now know the filesystem&#x27;s partition. In the example below, sda3 is the filesystem&#x27;s partition.</li><li>Use the Filesystem toolbox image to scan and repair.</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># docker run -it --rm --privileged registry.opensuse.org/isv/rancher/harvester/toolbox/main/fs-toolbox:latest -- bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then we try to scan with this target device.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="xfs">XFS<a class="hash-link" href="#xfs" title="Direct link to heading">â</a></h3><p>When scanning an XFS filesystem, use the <code>xfs_repair</code> command and specify the problematic partition of the device.</p><p>In the following example, <code>/dev/sda3</code> is the problematic partition.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># xfs_repair -n /dev/sda3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To repair the corrupted partition, run the following command.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># xfs_repair /dev/sda3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="ext4">EXT4<a class="hash-link" href="#ext4" title="Direct link to heading">â</a></h3><p>When scanning a EXT4 filesystem, use the <code>e2fsck</code> command as follows, where the <code>/dev/sde1</code> is the problematic partition of the device.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># e2fsck -f /dev/sde1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To repair the corrupted partition, run the following command.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># e2fsck -fp /dev/sde1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After using the &#x27;e2fsck&#x27; command, you should also see logs related to scanning and repairing the partition. Scanning and repairing the corrupted partition is successful if there are no errors in these logs. </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="detach-and-start-vm-again">Detach and Start VM again.<a class="hash-link" href="#detach-and-start-vm-again" title="Direct link to heading">â</a></h2><p>After the corrupted partition is scanned and repaired, detach the volume and try to start the related VM again.</p><ul><li>Detach the volume from the Longhorn UI.</li></ul><p><img loading="lazy" alt="detach volume on longhorn UI" src="/assets/images/detach_volume-a71a0c79f0a6052fd5ecb562bf532b71.png" width="2964" height="1364"></p><ul><li>Start the related VM again from the Harvester UI.</li></ul><p><img loading="lazy" alt="Start VM again" src="/assets/images/start_vm_again-6ce38c23de061f1587da9e4f8698b7e8.png" width="2540" height="854"></p><p>Your VM should now work normally.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/storage">storage</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/root">root</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/filesystem">filesystem</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-12T00:00:00.000Z" itemprop="datePublished">January 12, 2023</time> Â· <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/bk201.png" alt="Kiefer Chang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kiefer Chang</span></a></div><small class="avatar__subtitle" itemprop="description">Engineer Manager</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Harvester replicates volumes data across disks in a cluster. Before removing a disk, the user needs to evict replicas on the disk to other disks to preserve the volumes&#x27; configured availability. For more information about eviction in Longhorn, please check <a href="https://longhorn.io/docs/1.3.2/volumes-and-nodes/disks-or-nodes-eviction/" target="_blank" rel="noopener noreferrer">Evicting Replicas on Disabled Disks or Nodes</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="preparation">Preparation<a class="hash-link" href="#preparation" title="Direct link to heading">â</a></h2><p>This document describes how to evict Longhorn disks using the <code>kubectl</code> command. Before that, users must ensure the environment is set up correctly.
There are two recommended ways to do this:</p><ol><li>Log in to any management node and switch to root (<code>sudo -i</code>).</li><li>Download Kubeconfig file and use it locally<ul><li>Install <code>kubectl</code> and <code>yq</code> program manually.</li><li>Open Harvester GUI,  click <code>support</code> at the bottom left of the page and click <code>Download KubeConfig</code> to download the Kubeconfig file.</li><li>Set the Kubeconfig file&#x27;s path to <code>KUBECONFIG</code> environment variable. For example, <code>export KUBECONFIG=/path/to/kubeconfig</code>.</li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="evicting-replicas-from-a-disk">Evicting replicas from a disk<a class="hash-link" href="#evicting-replicas-from-a-disk" title="Direct link to heading">â</a></h2><ol><li><p>List Longhorn nodes (names are identical to Kubernetes nodes):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get -n longhorn-system nodes.longhorn.io</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sample output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   ALLOWSCHEDULING   SCHEDULABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node1   True    true              True          24d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node2   True    true              True          24d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node3   True    true              True          24d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>List disks on a node. Assume we want to evict replicas of a disk on <code>node1</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get -n longhorn-system nodes.longhorn.io node1 -o yaml | yq e &#x27;.spec.disks&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sample output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">default-disk-ed7af10f5b8356be:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowScheduling: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  evictionRequested: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path: /var/lib/harvester/defaultdisk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageReserved: 36900254515</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags: []</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Assume disk <code>default-disk-ed7af10f5b8356be</code> is the target we want to evict replicas out of.</p><p>Edit the node:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit -n longhorn-system nodes.longhorn.io node1 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Update these two fields and save:</p><ul><li><code>spec.disks.&lt;disk_name&gt;.allowScheduling</code> to <code>false</code></li><li><code>spec.disks.&lt;disk_name&gt;.evictionRequested</code> to <code>true</code></li></ul><p>Sample editing:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">default-disk-ed7af10f5b8356be:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowScheduling: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  evictionRequested: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path: /var/lib/harvester/defaultdisk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageReserved: 36900254515</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags: []</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Wait for all replicas on the disk to be evicted.</p><p>Get current scheduled replicas on the disk:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get -n longhorn-system nodes.longhorn.io node1 -o yaml | yq e &#x27;.status.diskStatus.default-disk-ed7af10f5b8356be.scheduledReplica&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sample output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pvc-86d3d212-d674-4c64-b69b-4a2eb1df2272-r-7b422db7: 5368709120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-b06f0b09-f30c-4936-8a2a-425b993dd6cb-r-bb0fa6b3: 2147483648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-b844bcc6-3b06-4367-a136-3909251cb560-r-08d1ab3c: 53687091200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-ea6e0dff-f446-4a38-916a-b3bea522f51c-r-193ca5c6: 10737418240</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the command repeatedly, and the output should eventually become an empty map:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This means Longhorn evicts replicas on the disk to other disks.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If a replica always stays in a disk, please open the <a href="https://docs.harvesterhci.io/v1.1/troubleshooting/harvester#access-embedded-rancher-and-longhorn-dashboards" target="_blank" rel="noopener noreferrer">Longhorn GUI</a> and check if there is free space on other disks.</p></div></div></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/storage">storage</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/disk">disk</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kb/page/2"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 harvesterhci.io</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f5155a29.js"></script>
<script src="/assets/js/main.9c23e8a1.js"></script>
</body>
</html>